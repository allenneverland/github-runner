version: '3.8'

services:
  # Rust Runner - 包含 postgresql-client
  rust-runner:
    image: myoung34/github-runner:latest
    container_name: rust-runner
    restart: unless-stopped
    environment:
      - REPO_URL=https://github.com/allenneverland/backtest-server
      - ACCESS_TOKEN=${ACCESS_TOKEN}
      - RUNNER_NAME=rust-runner
      - RUNNER_LABELS=rust,cargo,backend,linux,x64
      - RUNNER_GROUP=default
      - RUNNER_WORK_DIRECTORY=/tmp/runner/work
      - PATH=/home/runner/.local/bin:/home/runner/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - rust_runner_data:/tmp/runner
      - rust_cargo_cache:/home/runner/.cargo
    command: >
      bash -c "
        echo 'Installing system tools...' &&
        sudo apt-get update &&
        sudo apt-get install -y postgresql-client redis-tools build-essential curl &&
        echo 'Verifying pg_isready installation...' &&
        which pg_isready && pg_isready --version &&
        echo 'Starting GitHub runner...' &&
        exec /home/runner/entrypoint.sh
      "
    shm_size: '2gb'

  # Python & React Runner - 包含 postgresql-client
  python-react-runner:
    image: myoung34/github-runner:latest
    container_name: python-react-runner
    restart: unless-stopped
    environment:
      - REPO_URL=https://github.com/allenneverland/stratplat-web-server
      - ACCESS_TOKEN=${ACCESS_TOKEN}
      - RUNNER_NAME=python-react-runner
      - RUNNER_LABELS=python,react,nodejs,web,linux,x64
      - RUNNER_GROUP=default
      - RUNNER_WORK_DIRECTORY=/tmp/runner/work
      - PATH=/home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - python_react_runner_data:/tmp/runner
      - python_cache:/home/runner/.cache
    command: >
      bash -c "
        echo 'Installing system tools...' &&
        sudo apt-get update &&
        sudo apt-get install -y postgresql-client redis-tools python3-pip nodejs npm curl &&
        echo 'Verifying pg_isready installation...' &&
        which pg_isready && pg_isready --version &&
        echo 'Starting GitHub runner...' &&
        exec /home/runner/entrypoint.sh
      "
    shm_size: '2gb'

volumes:
  rust_runner_data:
  python_react_runner_data:
  rust_cargo_cache:
  python_cache: